<hc:Window x:Class="ProjectAlert.WPF.Views.AlertRuleEditDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:hc="https://handyorg.github.io/handycontrol"
        Title="预警规则配置"
        Height="600" Width="700"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize"
        ShowInTaskbar="False">

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="20,15,20,20">
            <!-- 基本信息 -->
            <GroupBox Header="基本信息" Margin="0,0,0,10" Padding="10,8">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="70"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="70"/>
                        <ColumnDefinition Width="140"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Row="0" Grid.Column="0" Text="规则名称" VerticalAlignment="Center"/>
                    <TextBox Grid.Row="0" Grid.Column="1" x:Name="TxtName" Margin="0,0,15,0"/>
                    <TextBlock Grid.Row="0" Grid.Column="2" Text="系统分类" VerticalAlignment="Center"/>
                    <ComboBox Grid.Row="0" Grid.Column="3" x:Name="CmbCategory"/>

                    <TextBlock Grid.Row="1" Grid.Column="0" Text="预警级别" VerticalAlignment="Center" Margin="0,8,0,0"/>
                    <ComboBox Grid.Row="1" Grid.Column="1" x:Name="CmbAlertLevel" Margin="0,8,15,0"/>
                    <TextBlock Grid.Row="1" Grid.Column="2" Text="Cron表达式" VerticalAlignment="Center" Margin="0,8,0,0"/>
                    <TextBox Grid.Row="1" Grid.Column="3" x:Name="TxtCron" Margin="0,8,0,0"/>
                </Grid>
            </GroupBox>

            <!-- 数据源配置 -->
            <GroupBox Header="数据源配置" Margin="0,0,0,10" Padding="10,8">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="70"/>
                        <ColumnDefinition Width="120"/>
                        <ColumnDefinition Width="70"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" Text="数据源类型" VerticalAlignment="Center"/>
                    <ComboBox Grid.Column="1" x:Name="CmbSourceType" Margin="0,0,15,0" SelectionChanged="CmbSourceType_SelectionChanged"/>
                    <TextBlock Grid.Column="2" Text="数据库连接" VerticalAlignment="Center" x:Name="LblDbConnection"/>
                    <ComboBox Grid.Column="3" x:Name="CmbDbConnection" DisplayMemberPath="Name"/>
                </Grid>
            </GroupBox>

            <!-- ========== SQL 数据源配置 ========== -->
            <StackPanel x:Name="PnlSqlConfig">
                <!-- SQL查询 -->
                <GroupBox Header="SQL查询" Margin="0,0,0,10" Padding="10,8" x:Name="GrpSql">
                    <StackPanel>
                        <TextBox x:Name="TxtSqlQuery" AcceptsReturn="True" TextWrapping="Wrap"
                                 Height="80" VerticalScrollBarVisibility="Auto"/>
                        <TextBlock Margin="0,5,0,0" FontSize="11" Foreground="#999">
                            <Run Text="单值预警: SELECT COUNT(*) as cnt FROM orders WHERE status='pending'"/>
                            <LineBreak/>
                            <Run Text="多行预警: SELECT error_id, customer_name, error_msg FROM error_logs WHERE status='unresolved'"/>
                        </TextBlock>
                    </StackPanel>
                </GroupBox>

                <!-- SQL判断配置 -->
                <GroupBox Header="判断配置" Margin="0,0,0,10" Padding="10,8" x:Name="GrpSqlJudge">
                    <StackPanel>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="55"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="判断方式" VerticalAlignment="Center"/>
                            <ComboBox Grid.Column="1" x:Name="CmbSqlJudgeType" SelectionChanged="CmbSqlJudgeType_SelectionChanged"/>
                        </Grid>

                        <!-- SQL单值预警配置 -->
                        <Grid x:Name="PnlSqlSingleValue" Margin="0,10,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="55"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="55"/>
                                <ColumnDefinition Width="80"/>
                                <ColumnDefinition Width="40"/>
                                <ColumnDefinition Width="100"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="判断字段" VerticalAlignment="Center"/>
                            <TextBox Grid.Column="1" x:Name="TxtSqlJudgeField" Margin="0,0,15,0"/>
                            <TextBlock Grid.Column="2" Text="运算符" VerticalAlignment="Center"/>
                            <ComboBox Grid.Column="3" x:Name="CmbSqlOperator" Margin="0,0,15,0"/>
                            <TextBlock Grid.Column="4" Text="阈值" VerticalAlignment="Center"/>
                            <TextBox Grid.Column="5" x:Name="TxtSqlThreshold"/>
                        </Grid>

                        <!-- SQL多行预警配置 -->
                        <Grid x:Name="PnlSqlMultiRow" Margin="0,10,0,0" Visibility="Collapsed">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="75"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="唯一标识字段" VerticalAlignment="Center"/>
                            <TextBox Grid.Column="1" x:Name="TxtSqlKeyField"/>
                        </Grid>
                        <TextBlock x:Name="TxtSqlKeyFieldHint" Margin="75,5,0,0" FontSize="11" Foreground="#999" Visibility="Collapsed"
                                   Text="用于区分不同预警项的字段名，每行数据生成一条独立预警"/>
                    </StackPanel>
                </GroupBox>
            </StackPanel>

            <!-- ========== API 数据源配置 ========== -->
            <StackPanel x:Name="PnlApiConfig" Visibility="Collapsed">
                <!-- API配置 -->
                <GroupBox Header="API配置" Margin="0,0,0,10" Padding="10,8" x:Name="GrpApi">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="55"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="55"/>
                            <ColumnDefinition Width="80"/>
                            <ColumnDefinition Width="55"/>
                            <ColumnDefinition Width="60"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="API URL" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="0" Grid.Column="1" x:Name="TxtApiUrl" Margin="0,0,15,0"/>
                        <TextBlock Grid.Row="0" Grid.Column="2" Text="请求方法" VerticalAlignment="Center"/>
                        <ComboBox Grid.Row="0" Grid.Column="3" x:Name="CmbApiMethod" Margin="0,0,15,0">
                            <ComboBoxItem Content="GET"/>
                            <ComboBoxItem Content="POST"/>
                        </ComboBox>
                        <TextBlock Grid.Row="0" Grid.Column="4" Text="超时(秒)" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="0" Grid.Column="5" x:Name="TxtApiTimeout"/>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="请求头" VerticalAlignment="Top" Margin="0,11,0,0"/>
                        <TextBox Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="5" x:Name="TxtApiHeaders" Margin="0,8,0,0" Height="40"
                                 AcceptsReturn="True" TextWrapping="Wrap" VerticalScrollBarVisibility="Auto"/>

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="请求体" VerticalAlignment="Top" Margin="0,11,0,0"/>
                        <TextBox Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="5" x:Name="TxtApiBody" Margin="0,8,0,0" Height="40"
                                 AcceptsReturn="True" TextWrapping="Wrap" VerticalScrollBarVisibility="Auto"/>
                    </Grid>
                </GroupBox>

                <!-- API判断配置 -->
                <GroupBox Header="判断配置" Margin="0,0,0,10" Padding="10,8" x:Name="GrpApiJudge">
                    <StackPanel>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="55"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="判断方式" VerticalAlignment="Center"/>
                            <ComboBox Grid.Column="1" x:Name="CmbApiJudgeType" SelectionChanged="CmbApiJudgeType_SelectionChanged"/>
                        </Grid>

                        <!-- 请求层判断配置 -->
                        <Grid x:Name="PnlApiRequestLevel" Margin="0,10,0,0" Visibility="Collapsed">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="55"/>
                                <ColumnDefinition Width="80"/>
                                <ColumnDefinition Width="40"/>
                                <ColumnDefinition Width="100"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="运算符" VerticalAlignment="Center"/>
                            <ComboBox Grid.Column="1" x:Name="CmbApiRequestOperator" Margin="0,0,15,0"/>
                            <TextBlock Grid.Column="2" Text="状态码" VerticalAlignment="Center"/>
                            <TextBox Grid.Column="3" x:Name="TxtApiStatusCode"/>
                        </Grid>
                        <TextBlock x:Name="TxtApiRequestHint" Margin="0,5,0,0" FontSize="11" Foreground="#999" Visibility="Collapsed"
                                   Text="判断HTTP请求是否成功，检查状态码"/>

                        <!-- 响应文本层判断配置 -->
                        <Grid x:Name="PnlApiTextLevel" Margin="0,10,0,0" Visibility="Collapsed">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="55"/>
                                <ColumnDefinition Width="100"/>
                                <ColumnDefinition Width="55"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="运算符" VerticalAlignment="Center"/>
                            <ComboBox Grid.Column="1" x:Name="CmbApiTextOperator" Margin="0,0,15,0"/>
                            <TextBlock Grid.Column="2" Text="匹配文本" VerticalAlignment="Center"/>
                            <TextBox Grid.Column="3" x:Name="TxtApiTextMatch"/>
                        </Grid>
                        <TextBlock x:Name="TxtApiTextHint" Margin="0,5,0,0" FontSize="11" Foreground="#999" Visibility="Collapsed"
                                   Text="将响应体当作字符串进行匹配"/>

                        <!-- JSON解析层_单值配置 -->
                        <StackPanel x:Name="PnlApiJsonSingle" Visibility="Collapsed">
                            <Grid Margin="0,10,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="55"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="55"/>
                                    <ColumnDefinition Width="150"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="数据路径" VerticalAlignment="Center"/>
                                <TextBox Grid.Column="1" x:Name="TxtApiJsonPath" Margin="0,0,15,0"/>
                                <TextBlock Grid.Column="2" Text="判断字段" VerticalAlignment="Center"/>
                                <TextBox Grid.Column="3" x:Name="TxtApiJsonField"/>
                            </Grid>
                            <Grid Margin="0,8,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="55"/>
                                    <ColumnDefinition Width="100"/>
                                    <ColumnDefinition Width="40"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="运算符" VerticalAlignment="Center"/>
                                <ComboBox Grid.Column="1" x:Name="CmbApiJsonOperator" Margin="0,0,15,0"/>
                                <TextBlock Grid.Column="2" Text="阈值" VerticalAlignment="Center"/>
                                <TextBox Grid.Column="3" x:Name="TxtApiJsonThreshold"/>
                            </Grid>
                        </StackPanel>
                        <TextBlock x:Name="TxtApiJsonSingleHint" Margin="0,5,0,0" FontSize="11" Foreground="#999" Visibility="Collapsed"
                                   Text="解析JSON后按路径提取数据，与阈值比较。数据路径如：data、data.errorCount"/>

                        <!-- JSON解析层_多行配置 -->
                        <StackPanel x:Name="PnlApiJsonMulti" Visibility="Collapsed">
                            <Grid Margin="0,10,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="55"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="75"/>
                                    <ColumnDefinition Width="150"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="数据路径" VerticalAlignment="Center"/>
                                <TextBox Grid.Column="1" x:Name="TxtApiJsonMultiPath" Margin="0,0,15,0"/>
                                <TextBlock Grid.Column="2" Text="唯一标识字段" VerticalAlignment="Center"/>
                                <TextBox Grid.Column="3" x:Name="TxtApiJsonKeyField"/>
                            </Grid>
                        </StackPanel>
                        <TextBlock x:Name="TxtApiJsonMultiHint" Margin="0,5,0,0" FontSize="11" Foreground="#999" Visibility="Collapsed"
                                   Text="解析JSON数组，有数据即预警。数据路径如：data.items"/>
                    </StackPanel>
                </GroupBox>
            </StackPanel>

            <!-- 预警配置 (通用) -->
            <GroupBox Header="预警配置" Margin="0,0,0,10" Padding="10,8">
                <StackPanel>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="110"/>
                            <ColumnDefinition Width="60"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="连续失败N次才预警" VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1" x:Name="TxtFailThreshold"/>
                    </Grid>
                    <TextBlock Text="消息模板" Margin="0,10,0,5"/>
                    <TextBox x:Name="TxtMessageTemplate" Height="45"
                             AcceptsReturn="True" TextWrapping="Wrap" VerticalScrollBarVisibility="Auto"/>
                    <TextBlock x:Name="TxtMessageTemplateHint" Margin="0,5,0,0" FontSize="11" Foreground="#999" TextWrapping="Wrap"/>
                </StackPanel>
            </GroupBox>

            <!-- 底部：启用状态 + 按钮 -->
            <Grid Margin="0,5,0,0">
                <CheckBox x:Name="ChkEnabled" Content="启用此规则" VerticalAlignment="Center" HorizontalAlignment="Left"/>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <Button Content="保存" Click="BtnSave_Click" Style="{StaticResource ButtonPrimary}"/>
                    <Button Content="取消" Click="BtnCancel_Click" Margin="10,0,0,0" Style="{StaticResource ButtonDefault}"/>
                </StackPanel>
            </Grid>
        </StackPanel>
    </ScrollViewer>
</hc:Window>
