# 技术选型 V2

## 1. V2 架构变更说明

相比 V1 版本，V2 采用极简架构：

| 对比项 | V1 | V2 |
|--------|----|----|
| 后端服务 | .NET 8 WebAPI | **移除** |
| 管理端 | Vue 3 Web | **移除** |
| 配置存储 | MySQL | **SQLite（本地）** |
| 任务调度 | API 内 Quartz | **WPF 内嵌 Quartz** |
| 部署方式 | Docker Compose | **单体 WPF 安装** |

**V2 核心理念**：一个 WPF 桌面程序包含所有功能，启动即运行。

---

## 2. 技术栈概览

| 层级 | 技术选型 | 版本 |
|------|---------|------|
| **桌面客户端** | WPF | .NET 8.0 |
| **本地数据库** | SQLite | 3.x |
| **ORM** | Dapper | 2.1+ |
| **定时调度** | Quartz.NET | 3.8+ |
| **HTTP 客户端** | HttpClient | 内置 |
| **MVVM 框架** | CommunityToolkit.Mvvm | 8.2+ |
| **UI 组件库** | HandyControl | 3.5+ |
| **图表组件** | LiveCharts2 | 2.0+ |

---

## 3. 解决方案结构

```
ProjectAlert.sln
├── src/
│   ├── ProjectAlert.WPF/            # WPF 桌面客户端（主入口）
│   │   ├── Views/                   # 视图
│   │   ├── ViewModels/              # 视图模型
│   │   ├── Services/                # 服务层
│   │   │   ├── Scheduler/           # Quartz 调度服务
│   │   │   ├── Executor/            # 预警/统计执行器
│   │   │   └── Notification/        # 通知服务
│   │   └── App.xaml
│   │
│   ├── ProjectAlert.Domain/         # 领域模型
│   │   ├── Entities/                # 实体
│   │   ├── Enums/                   # 枚举（含 SystemCategory）
│   │   └── Interfaces/              # 仓储接口
│   │
│   ├── ProjectAlert.Repository/     # 数据访问层
│   │   ├── SqliteContext.cs         # SQLite 连接管理
│   │   └── Repositories/            # 仓储实现
│   │
│   └── ProjectAlert.Shared/         # 共享工具类
│       ├── Extensions/              # 扩展方法
│       ├── Helpers/                 # 辅助类
│       └── Constants/               # 常量
│
└── docs/
    ├── prd/
    │   ├── PRDv2.md
    │   └── v2/                      # HTML 原型
    └── 技术选型v2.md
```

### 3.1 各层职责

| 项目 | 职责 | 依赖 |
|------|------|------|
| **ProjectAlert.Shared** | 通用工具、扩展方法、常量 | 无 |
| **ProjectAlert.Domain** | 实体、枚举、仓储接口 | Shared |
| **ProjectAlert.Repository** | SQLite 数据访问、Dapper 查询 | Domain, Shared |
| **ProjectAlert.WPF** | UI、业务逻辑、Quartz 调度 | 全部 |

---

## 4. 本地数据库

### 4.1 SQLite 选型

| 特性 | 说明 |
|------|------|
| 零配置 | 无需安装数据库服务，文件即数据库 |
| 轻量级 | 单 DLL，约 1MB |
| 跨平台 | Windows/Linux/macOS 通用 |
| 事务支持 | 完整 ACID 支持 |

```xml
<PackageReference Include="Microsoft.Data.Sqlite" Version="8.0.0" />
```

### 4.2 数据库文件位置

```csharp
// 数据库文件存储在用户应用数据目录
var dbPath = Path.Combine(
    Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData),
    "ProjectAlert",
    "data.db"
);
```

### 4.3 数据库初始化

```csharp
public class SqliteContext
{
    private readonly string _connectionString;

    public SqliteContext()
    {
        var dbPath = GetDbPath();
        EnsureDirectoryExists(dbPath);
        _connectionString = $"Data Source={dbPath}";
        InitializeDatabase();
    }

    public IDbConnection CreateConnection()
    {
        return new SqliteConnection(_connectionString);
    }

    private void InitializeDatabase()
    {
        using var connection = CreateConnection();
        connection.Open();

        // 执行建表脚本
        var sql = GetInitSql();
        connection.Execute(sql);
    }
}
```

### 4.4 数据表结构

```sql
-- 数据库连接配置
CREATE TABLE IF NOT EXISTS db_connections (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    db_type TEXT NOT NULL,  -- MySql / SqlServer
    connection_string TEXT NOT NULL,
    enabled INTEGER DEFAULT 1,
    created_at TEXT DEFAULT (datetime('now', 'localtime')),
    updated_at TEXT DEFAULT (datetime('now', 'localtime'))
);

-- 预警规则
CREATE TABLE IF NOT EXISTS alert_rules (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    category INTEGER DEFAULT 0,  -- SystemCategory 枚举值
    source_type TEXT NOT NULL,   -- Sql / Api

    -- SQL 配置
    db_connection_id INTEGER,
    sql_query TEXT,

    -- API 配置（内联）
    api_url TEXT,
    api_method TEXT,
    api_headers TEXT,
    api_body TEXT,
    api_timeout INTEGER DEFAULT 30,

    -- 判断配置
    judge_level TEXT,
    data_path TEXT,
    judge_type TEXT,
    judge_field TEXT,
    judge_operator TEXT,
    judge_value TEXT,
    key_field TEXT,

    -- 预警配置
    alert_level INTEGER DEFAULT 1,
    message_template TEXT,
    cron_expression TEXT NOT NULL,
    fail_threshold INTEGER DEFAULT 1,
    current_fail_count INTEGER DEFAULT 0,

    -- 状态
    enabled INTEGER DEFAULT 1,
    last_run_time TEXT,
    last_run_success INTEGER,
    last_run_result TEXT,

    created_at TEXT DEFAULT (datetime('now', 'localtime')),
    updated_at TEXT DEFAULT (datetime('now', 'localtime')),

    FOREIGN KEY (db_connection_id) REFERENCES db_connections(id)
);

-- 统计配置
CREATE TABLE IF NOT EXISTS stat_configs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    category INTEGER DEFAULT 0,
    source_type TEXT NOT NULL,

    -- SQL 配置
    db_connection_id INTEGER,
    sql_query TEXT,

    -- API 配置（内联）
    api_url TEXT,
    api_method TEXT,
    api_headers TEXT,
    api_body TEXT,
    api_timeout INTEGER DEFAULT 30,
    data_path TEXT,

    -- 图表配置
    chart_type TEXT NOT NULL,
    chart_config TEXT,
    refresh_interval INTEGER DEFAULT 60,
    sort_order INTEGER DEFAULT 0,

    enabled INTEGER DEFAULT 1,
    created_at TEXT DEFAULT (datetime('now', 'localtime')),
    updated_at TEXT DEFAULT (datetime('now', 'localtime')),

    FOREIGN KEY (db_connection_id) REFERENCES db_connections(id)
);

-- 当前预警
CREATE TABLE IF NOT EXISTS current_alerts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    rule_id INTEGER NOT NULL,
    alert_key TEXT,
    message TEXT NOT NULL,
    alert_level INTEGER NOT NULL,
    status INTEGER DEFAULT 0,
    first_time TEXT NOT NULL,
    last_time TEXT NOT NULL,
    occur_count INTEGER DEFAULT 1,
    created_at TEXT DEFAULT (datetime('now', 'localtime')),
    updated_at TEXT DEFAULT (datetime('now', 'localtime')),

    FOREIGN KEY (rule_id) REFERENCES alert_rules(id)
);

-- 已忽略预警
CREATE TABLE IF NOT EXISTS ignored_alerts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    rule_id INTEGER NOT NULL,
    alert_key TEXT,
    ignored_at TEXT NOT NULL,

    FOREIGN KEY (rule_id) REFERENCES alert_rules(id)
);

-- 应用设置
CREATE TABLE IF NOT EXISTS app_settings (
    key TEXT PRIMARY KEY,
    value TEXT
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_alert_rules_category ON alert_rules(category);
CREATE INDEX IF NOT EXISTS idx_alert_rules_enabled ON alert_rules(enabled);
CREATE INDEX IF NOT EXISTS idx_current_alerts_rule_id ON current_alerts(rule_id);
CREATE INDEX IF NOT EXISTS idx_current_alerts_status ON current_alerts(status);
CREATE INDEX IF NOT EXISTS idx_stat_configs_category ON stat_configs(category);
```

---

## 5. ORM 选型

### 5.1 Dapper

```xml
<PackageReference Include="Dapper" Version="2.1.35" />
<PackageReference Include="Dapper.Contrib" Version="2.0.78" />
```

| 优势 | 说明 |
|------|------|
| 轻量高效 | 接近原生 ADO.NET 性能 |
| 灵活查询 | 直接编写 SQL，适合动态查询 |
| 简单易用 | API 简洁，学习成本低 |

### 5.2 仓储实现示例

```csharp
public class AlertRuleRepository : IAlertRuleRepository
{
    private readonly SqliteContext _context;

    public AlertRuleRepository(SqliteContext context)
    {
        _context = context;
    }

    public async Task<IEnumerable<AlertRule>> GetEnabledRulesAsync()
    {
        using var conn = _context.CreateConnection();
        return await conn.QueryAsync<AlertRule>(
            "SELECT * FROM alert_rules WHERE enabled = 1"
        );
    }

    public async Task<AlertRule?> GetByIdAsync(int id)
    {
        using var conn = _context.CreateConnection();
        return await conn.QueryFirstOrDefaultAsync<AlertRule>(
            "SELECT * FROM alert_rules WHERE id = @Id",
            new { Id = id }
        );
    }

    public async Task<int> InsertAsync(AlertRule rule)
    {
        using var conn = _context.CreateConnection();
        return await conn.InsertAsync(rule);
    }

    public async Task UpdateAsync(AlertRule rule)
    {
        using var conn = _context.CreateConnection();
        await conn.UpdateAsync(rule);
    }
}
```

---

## 6. 多数据库连接

### 6.1 目标数据库支持

监控规则需要连接用户配置的目标数据库：

| 数据库类型 | 连接组件 | NuGet 包 |
|-----------|---------|----------|
| MySQL | MySqlConnector | `MySqlConnector` |
| SQL Server | Microsoft.Data.SqlClient | `Microsoft.Data.SqlClient` |

```xml
<PackageReference Include="MySqlConnector" Version="2.3.7" />
<PackageReference Include="Microsoft.Data.SqlClient" Version="5.2.0" />
```

### 6.2 连接工厂

```csharp
public interface IDbConnectionFactory
{
    IDbConnection CreateConnection(DbConnection config);
}

public class DbConnectionFactory : IDbConnectionFactory
{
    public IDbConnection CreateConnection(DbConnection config)
    {
        return config.DbType switch
        {
            DbType.MySql => new MySqlConnection(config.ConnectionString),
            DbType.SqlServer => new SqlConnection(config.ConnectionString),
            _ => throw new NotSupportedException($"不支持的数据库类型: {config.DbType}")
        };
    }
}
```

### 6.3 连接测试

```csharp
public async Task<bool> TestConnectionAsync(DbConnection config)
{
    try
    {
        using var conn = _factory.CreateConnection(config);
        await conn.OpenAsync();
        return true;
    }
    catch
    {
        return false;
    }
}
```

---

## 7. 定时任务调度

### 7.1 Quartz.NET 内嵌

```xml
<PackageReference Include="Quartz" Version="3.8.1" />
<PackageReference Include="Quartz.Extensions.DependencyInjection" Version="3.8.1" />
```

### 7.2 调度服务

```csharp
public class SchedulerService : IHostedService
{
    private readonly IScheduler _scheduler;
    private readonly IAlertRuleRepository _ruleRepo;

    public SchedulerService(
        ISchedulerFactory schedulerFactory,
        IAlertRuleRepository ruleRepo)
    {
        _scheduler = schedulerFactory.GetScheduler().Result;
        _ruleRepo = ruleRepo;
    }

    public async Task StartAsync(CancellationToken cancellationToken)
    {
        await _scheduler.Start(cancellationToken);
        await LoadAllJobs();
    }

    public async Task StopAsync(CancellationToken cancellationToken)
    {
        await _scheduler.Shutdown(cancellationToken);
    }

    private async Task LoadAllJobs()
    {
        var rules = await _ruleRepo.GetEnabledRulesAsync();
        foreach (var rule in rules)
        {
            await ScheduleJob(rule);
        }
    }

    public async Task ScheduleJob(AlertRule rule)
    {
        var job = JobBuilder.Create<AlertCheckJob>()
            .WithIdentity($"alert-{rule.Id}")
            .UsingJobData("RuleId", rule.Id)
            .Build();

        var trigger = TriggerBuilder.Create()
            .WithIdentity($"trigger-{rule.Id}")
            .WithCronSchedule(rule.CronExpression)
            .Build();

        await _scheduler.ScheduleJob(job, trigger);
    }

    public async Task RemoveJob(int ruleId)
    {
        await _scheduler.DeleteJob(new JobKey($"alert-{ruleId}"));
    }

    public async Task PauseAll()
    {
        await _scheduler.PauseAll();
    }

    public async Task ResumeAll()
    {
        await _scheduler.ResumeAll();
    }
}
```

### 7.3 预警检查任务

```csharp
public class AlertCheckJob : IJob
{
    private readonly IAlertRuleRepository _ruleRepo;
    private readonly IAlertExecutor _executor;
    private readonly ICurrentAlertRepository _alertRepo;

    public async Task Execute(IJobExecutionContext context)
    {
        var ruleId = context.JobDetail.JobDataMap.GetInt("RuleId");
        var rule = await _ruleRepo.GetByIdAsync(ruleId);

        if (rule == null || !rule.Enabled) return;

        var result = await _executor.ExecuteAsync(rule);
        await ProcessResult(rule, result);
    }

    private async Task ProcessResult(AlertRule rule, ExecuteResult result)
    {
        // 更新规则执行状态
        rule.LastRunTime = DateTime.Now;
        rule.LastRunSuccess = result.Success;
        rule.LastRunResult = result.Message;

        if (result.ShouldAlert)
        {
            await _alertRepo.AddOrUpdateAlertAsync(rule, result);
        }
        else
        {
            await _alertRepo.TryRecoverAlertAsync(rule.Id);
        }

        await _ruleRepo.UpdateAsync(rule);
    }
}
```

---

## 8. HTTP 客户端

### 8.1 API 请求服务

```csharp
public class ApiExecutor
{
    private readonly HttpClient _httpClient;

    public ApiExecutor(IHttpClientFactory httpClientFactory)
    {
        _httpClient = httpClientFactory.CreateClient("AlertApi");
    }

    public async Task<ApiResponse> ExecuteAsync(AlertRule rule)
    {
        var request = new HttpRequestMessage(
            GetMethod(rule.ApiMethod),
            rule.ApiUrl
        );

        // 添加请求头
        if (!string.IsNullOrEmpty(rule.ApiHeaders))
        {
            var headers = JsonSerializer.Deserialize<Dictionary<string, string>>(rule.ApiHeaders);
            foreach (var header in headers!)
            {
                request.Headers.TryAddWithoutValidation(header.Key, header.Value);
            }
        }

        // 添加请求体
        if (!string.IsNullOrEmpty(rule.ApiBody))
        {
            request.Content = new StringContent(
                rule.ApiBody,
                Encoding.UTF8,
                "application/json"
            );
        }

        using var cts = new CancellationTokenSource(
            TimeSpan.FromSeconds(rule.ApiTimeout ?? 30)
        );

        var response = await _httpClient.SendAsync(request, cts.Token);
        var content = await response.Content.ReadAsStringAsync();

        return new ApiResponse
        {
            StatusCode = (int)response.StatusCode,
            IsSuccess = response.IsSuccessStatusCode,
            Content = content
        };
    }
}
```

### 8.2 HttpClient 配置

```csharp
// App.xaml.cs 或 DI 配置
services.AddHttpClient("AlertApi", client =>
{
    client.Timeout = TimeSpan.FromSeconds(60);
    client.DefaultRequestHeaders.Add("User-Agent", "ProjectAlert/2.0");
});
```

---

## 9. WPF 客户端

### 9.1 MVVM 框架

```xml
<PackageReference Include="CommunityToolkit.Mvvm" Version="8.2.2" />
```

```csharp
public partial class MainViewModel : ObservableObject
{
    [ObservableProperty]
    private ObservableCollection<AlertRule> _alertRules = new();

    [ObservableProperty]
    private bool _isLoading;

    [RelayCommand]
    private async Task LoadRulesAsync()
    {
        IsLoading = true;
        var rules = await _ruleRepo.GetAllAsync();
        AlertRules = new ObservableCollection<AlertRule>(rules);
        IsLoading = false;
    }

    [RelayCommand]
    private async Task SaveRuleAsync(AlertRule rule)
    {
        await _ruleRepo.UpdateAsync(rule);
        await _scheduler.RescheduleJob(rule);
    }
}
```

### 9.2 UI 组件库

```xml
<PackageReference Include="HandyControl" Version="3.5.0" />
```

HandyControl 提供：
- 现代化控件样式
- 消息通知组件
- 对话框封装
- 数据表格增强

### 9.3 图表组件

```xml
<PackageReference Include="LiveChartsCore.SkiaSharpView.WPF" Version="2.0.0-rc2" />
```

```xaml
<lvc:CartesianChart Series="{Binding Series}" XAxes="{Binding XAxes}" />
```

```csharp
public ISeries[] Series { get; set; } = new ISeries[]
{
    new LineSeries<double>
    {
        Values = new double[] { 2, 1, 3, 5, 3, 4, 6 },
        Fill = null
    }
};
```

### 9.4 项目结构

```
ProjectAlert.WPF/
├── Views/
│   ├── MainWindow.xaml              # 主窗口
│   ├── FloatingWindow.xaml          # 悬浮窗
│   ├── DbConnectionView.xaml        # 数据库连接管理
│   ├── AlertRuleView.xaml           # 预警规则配置
│   ├── AlertRuleEditDialog.xaml     # 规则编辑弹窗
│   ├── StatConfigView.xaml          # 统计配置
│   ├── CurrentAlertView.xaml        # 当前预警
│   ├── IgnoredAlertView.xaml        # 已忽略预警
│   ├── SettingsView.xaml            # 设置页
│   └── StatDisplayWindow.xaml       # 统计展示窗口
├── ViewModels/
│   ├── MainViewModel.cs
│   ├── FloatingViewModel.cs
│   ├── DbConnectionViewModel.cs
│   ├── AlertRuleViewModel.cs
│   ├── StatConfigViewModel.cs
│   └── SettingsViewModel.cs
├── Services/
│   ├── Scheduler/
│   │   ├── SchedulerService.cs      # Quartz 调度服务
│   │   └── AlertCheckJob.cs         # 预警检查任务
│   ├── Executor/
│   │   ├── IAlertExecutor.cs
│   │   ├── SqlAlertExecutor.cs      # SQL 预警执行器
│   │   ├── ApiAlertExecutor.cs      # API 预警执行器
│   │   └── StatQueryExecutor.cs     # 统计查询执行器
│   ├── NavigationService.cs         # 页面导航
│   └── TrayIconService.cs           # 托盘图标服务
├── Converters/                       # 值转换器
├── Resources/
│   ├── Styles/
│   └── Icons/
├── App.xaml
└── App.xaml.cs
```

---

## 10. 依赖注入配置

```csharp
// App.xaml.cs
public partial class App : Application
{
    private IHost _host;

    protected override void OnStartup(StartupEventArgs e)
    {
        _host = Host.CreateDefaultBuilder()
            .ConfigureServices((context, services) =>
            {
                // 数据库
                services.AddSingleton<SqliteContext>();

                // 仓储
                services.AddScoped<IDbConnectionRepository, DbConnectionRepository>();
                services.AddScoped<IAlertRuleRepository, AlertRuleRepository>();
                services.AddScoped<IStatConfigRepository, StatConfigRepository>();
                services.AddScoped<ICurrentAlertRepository, CurrentAlertRepository>();

                // 服务
                services.AddSingleton<IDbConnectionFactory, DbConnectionFactory>();
                services.AddScoped<SqlAlertExecutor>();
                services.AddScoped<ApiAlertExecutor>();
                services.AddScoped<StatQueryExecutor>();

                // HTTP
                services.AddHttpClient("AlertApi");

                // Quartz
                services.AddQuartz(q =>
                {
                    q.UseMicrosoftDependencyInjectionJobFactory();
                });
                services.AddSingleton<SchedulerService>();
                services.AddHostedService(sp => sp.GetRequiredService<SchedulerService>());

                // ViewModels
                services.AddTransient<MainViewModel>();
                services.AddTransient<FloatingViewModel>();
                services.AddTransient<DbConnectionViewModel>();
                services.AddTransient<AlertRuleViewModel>();
                services.AddTransient<StatConfigViewModel>();
                services.AddTransient<SettingsViewModel>();

                // Views
                services.AddTransient<MainWindow>();
                services.AddTransient<FloatingWindow>();
            })
            .Build();

        _host.Start();

        var mainWindow = _host.Services.GetRequiredService<MainWindow>();
        mainWindow.Show();
    }

    protected override void OnExit(ExitEventArgs e)
    {
        _host.StopAsync().Wait();
        _host.Dispose();
        base.OnExit(e);
    }
}
```

---

## 11. NuGet 包清单

```xml
<ItemGroup>
    <!-- 数据库 - 本地存储 -->
    <PackageReference Include="Microsoft.Data.Sqlite" Version="8.0.0" />
    <PackageReference Include="Dapper" Version="2.1.35" />
    <PackageReference Include="Dapper.Contrib" Version="2.0.78" />

    <!-- 数据库 - 目标连接 -->
    <PackageReference Include="MySqlConnector" Version="2.3.7" />
    <PackageReference Include="Microsoft.Data.SqlClient" Version="5.2.0" />

    <!-- 定时任务 -->
    <PackageReference Include="Quartz" Version="3.8.1" />
    <PackageReference Include="Quartz.Extensions.DependencyInjection" Version="3.8.1" />

    <!-- HTTP -->
    <PackageReference Include="Microsoft.Extensions.Http" Version="8.0.0" />

    <!-- 依赖注入 -->
    <PackageReference Include="Microsoft.Extensions.Hosting" Version="8.0.0" />

    <!-- MVVM -->
    <PackageReference Include="CommunityToolkit.Mvvm" Version="8.2.2" />

    <!-- UI 组件 -->
    <PackageReference Include="HandyControl" Version="3.5.0" />

    <!-- 图表 -->
    <PackageReference Include="LiveChartsCore.SkiaSharpView.WPF" Version="2.0.0-rc2" />

    <!-- JSON -->
    <PackageReference Include="System.Text.Json" Version="8.0.0" />

    <!-- 日志（可选） -->
    <PackageReference Include="Serilog" Version="3.1.1" />
    <PackageReference Include="Serilog.Sinks.File" Version="5.0.0" />
</ItemGroup>
```

---

## 12. 应用生命周期

### 12.1 启动流程

```
┌─────────────────────────────────────────────────────────────┐
│                      应用启动流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   App.OnStartup()                                           │
│         │                                                   │
│         ▼                                                   │
│   ┌─────────────────┐                                       │
│   │  初始化 DI 容器  │                                       │
│   └────────┬────────┘                                       │
│            │                                                │
│            ▼                                                │
│   ┌─────────────────┐                                       │
│   │ 初始化 SQLite   │ ← 检查/创建数据库文件                  │
│   └────────┬────────┘                                       │
│            │                                                │
│            ▼                                                │
│   ┌─────────────────┐                                       │
│   │ 启动 Quartz     │ ← 加载所有启用的预警规则               │
│   └────────┬────────┘                                       │
│            │                                                │
│            ▼                                                │
│   ┌─────────────────┐                                       │
│   │ 显示主窗口/托盘 │ ← 根据设置决定显示方式                 │
│   └─────────────────┘                                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 12.2 托盘图标

```csharp
public class TrayIconService : IDisposable
{
    private readonly NotifyIcon _trayIcon;

    public TrayIconService()
    {
        _trayIcon = new NotifyIcon
        {
            Icon = LoadIcon(),
            Visible = true,
            Text = "项目监控"
        };

        _trayIcon.ContextMenuStrip = CreateContextMenu();
        _trayIcon.DoubleClick += (s, e) => ShowMainWindow();
    }

    private ContextMenuStrip CreateContextMenu()
    {
        var menu = new ContextMenuStrip();
        menu.Items.Add("打开主窗口", null, (s, e) => ShowMainWindow());
        menu.Items.Add("显示悬浮窗", null, (s, e) => ToggleFloatingWindow());
        menu.Items.Add("-");
        menu.Items.Add("暂停任务", null, (s, e) => PauseScheduler());
        menu.Items.Add("刷新数据", null, (s, e) => RefreshAll());
        menu.Items.Add("-");
        menu.Items.Add("退出", null, (s, e) => ExitApplication());
        return menu;
    }

    public void UpdateBadge(int alertCount)
    {
        // 更新图标显示预警数量角标
        _trayIcon.Icon = alertCount > 0 ? LoadAlertIcon(alertCount) : LoadNormalIcon();
    }
}
```

---

## 13. 开发环境要求

| 工具 | 版本要求 | 说明 |
|------|---------|------|
| Visual Studio | 2022 17.8+ | 需安装 .NET 桌面开发工作负载 |
| .NET SDK | 8.0+ | 运行时 |
| Git | 2.0+ | 版本控制 |

### 13.1 开发调试

```bash
# 克隆项目
git clone https://your-repo/ProjectAlert.git

# 打开解决方案
cd ProjectAlert
start ProjectAlert.sln

# 或使用命令行运行
cd src/ProjectAlert.WPF
dotnet run
```

---

## 14. 发布部署

### 14.1 发布配置

```xml
<!-- ProjectAlert.WPF.csproj -->
<PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net8.0-windows</TargetFramework>
    <UseWPF>true</UseWPF>
    <ApplicationIcon>Resources\app.ico</ApplicationIcon>

    <!-- 单文件发布 -->
    <PublishSingleFile>true</PublishSingleFile>
    <SelfContained>true</SelfContained>
    <RuntimeIdentifier>win-x64</RuntimeIdentifier>
    <IncludeNativeLibrariesForSelfExtract>true</IncludeNativeLibrariesForSelfExtract>
</PropertyGroup>
```

### 14.2 发布命令

```bash
# 发布为单文件可执行程序
dotnet publish -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true

# 输出目录
# bin/Release/net8.0-windows/win-x64/publish/ProjectAlert.exe
```

### 14.3 安装包制作（可选）

使用 Inno Setup 或 WiX 制作安装包：

```
安装包包含：
├── ProjectAlert.exe       # 主程序
├── data.db                # 初始数据库（可选）
└── 开机自启动注册（可选）
```

---

## 15. 与 V1 版本对比总结

| 方面 | V1 | V2 |
|------|----|----|
| **复杂度** | Web + API + WPF + MySQL | 仅 WPF + SQLite |
| **部署难度** | Docker Compose | 双击运行 |
| **维护成本** | 多服务运维 | 单程序维护 |
| **网络依赖** | API 通信 | 无（本地数据库） |
| **适用场景** | 多用户/团队 | 个人/单机使用 |
| **扩展性** | 高 | 低 |

**V2 适用于**：个人开发者、运维人员在本机使用的轻量级监控工具。
