# 项目监控 V2 - 产品需求文档

## 1. 项目概述

一个轻量级的桌面监控工具，支持两大核心功能：
1. **预警监控**：定时执行 SQL 查询或 API 调用，当结果不符合预期时触发预警
2. **数据统计**：配置统计规则，定时查询数据并以表格或图表形式展示

### 1.1 V2 设计原则

相比 V1，V2 遵循以下简化原则：
- **无管理端**：所有配置直接在桌面客户端完成，无需单独的 Web 管理端
- **无后端服务**：任务调度服务内嵌在客户端中，启动即运行
- **枚举代替管理**：系统分类使用枚举值，无需动态管理
- **简化数据源**：数据库连接集中管理，API 配置内联在规则中

### 1.2 目标用户
开发/运维人员、项目管理者

### 1.3 使用场景
- 监控业务数据异常（订单积压、库存预警等）
- 监控系统指标（API响应时间、错误率等）
- 定时检查数据一致性
- 站点健康检查（定时访问API，检测是否可用）
- 数据统计展示（实时查看业务数据指标、趋势图等）

---

## 2. 系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                     V2 精简架构                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │                  桌面客户端 (WPF)                     │  │
│   │                                                       │  │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │  │
│   │  │  配置管理    │  │  任务调度    │  │  数据展示    │  │  │
│   │  │             │  │             │  │             │  │  │
│   │  │ • 数据库连接 │  │ • Quartz    │  │ • 悬浮窗    │  │  │
│   │  │ • 预警规则  │  │ • 预警检测   │  │ • 预警列表  │  │  │
│   │  │ • 统计配置  │  │ • 统计查询   │  │ • 统计图表  │  │  │
│   │  └─────────────┘  └─────────────┘  └─────────────┘  │  │
│   │                         │                            │  │
│   │                         ▼                            │  │
│   │              ┌─────────────────────┐                │  │
│   │              │     本地 SQLite     │                │  │
│   │              │     配置数据库       │                │  │
│   │              └─────────────────────┘                │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 技术选型

| 组件 | 技术方案 |
|------|---------|
| 桌面客户端 | WPF + .NET 8 |
| 任务调度 | Quartz.NET（内嵌） |
| 本地存储 | SQLite |
| 数据库连接 | SQL Server / MySQL |
| HTTP 请求 | HttpClient |
| 图表 | LiveCharts2 |
| UI 框架 | HandyControl |

---

## 3. 功能需求

### 3.1 系统分类（枚举）

使用枚举值对预警规则和统计配置进行分类，无需动态管理。

```csharp
public enum SystemCategory
{
    [Description("默认")]
    Default = 0,

    [Description("订单中心")]
    OrderCenter = 1,

    [Description("支付中心")]
    PaymentCenter = 2,

    [Description("用户中心")]
    UserCenter = 3,

    [Description("库存中心")]
    InventoryCenter = 4,

    [Description("物流中心")]
    LogisticsCenter = 5,

    [Description("营销中心")]
    MarketingCenter = 6,

    [Description("系统监控")]
    SystemMonitor = 7,

    [Description("其他")]
    Other = 99
}
```

> 注：如需新增分类，直接修改枚举定义，重新编译即可。

### 3.2 数据库连接管理

集中管理数据库连接配置，供预警规则和统计配置引用。

| 字段 | 说明 |
|------|------|
| 连接名称 | 显示名称（如：业务主库、只读库） |
| 数据库类型 | SQL Server / MySQL |
| 连接字符串 | 完整的数据库连接串 |
| 是否启用 | 停用的连接不可被选择 |

**功能**：
- 增删改查数据库连接
- 连接测试
- 连接列表供规则配置时下拉选择

### 3.3 预警规则配置

#### 3.3.1 通用字段

| 字段 | 说明 |
|------|------|
| 规则名称 | 规则的显示名称 |
| 系统分类 | 枚举选择（下拉框） |
| 数据源类型 | SQL / API（切换显示不同配置项） |
| 预警级别 | 信息 / 警告 / 严重 |
| 连续失败次数 | 连续失败N次才预警（默认1） |
| 定时规则 | Cron 表达式 |
| 消息模板 | 预警消息模板，支持变量 |
| 启用状态 | 是否启用 |

#### 3.3.2 SQL 数据源配置

当数据源类型选择 SQL 时，显示以下配置：

| 字段 | 说明 |
|------|------|
| 数据库连接 | 下拉选择已配置的数据库连接 |
| SQL 语句 | 要执行的查询语句 |
| 判断方式 | 单值预警 / 多行预警 |
| 判断字段 | （单值）用于判断的列名 |
| 运算符 | （单值）比较运算符 |
| 阈值 | （单值）比较阈值 |
| 唯一标识字段 | （多行）用于区分不同预警的列名 |

#### 3.3.3 API 数据源配置

当数据源类型选择 API 时，**直接在规则中配置 API 信息**（无需单独管理）：

| 字段 | 说明 |
|------|------|
| 请求地址 | API URL |
| 请求方式 | GET / POST |
| 请求头 | JSON 格式（可选） |
| 请求体 | 请求内容（可选） |
| 超时时间 | 秒（默认30） |
| 判断层级 | 请求层 / 响应文本层 / JSON解析层 |
| 数据路径 | （JSON解析层）提取数据的路径 |
| 判断方式 | 根据判断层级不同而变化 |
| 判断字段/运算符/阈值 | 同 SQL 配置 |
| 唯一标识字段 | （多行预警）用于区分不同预警 |

#### 3.3.4 判断方式说明

**SQL 数据源**

| 判断方式 | 说明 |
|----------|------|
| 单值预警 | SQL 返回单行单列，取值与阈值比较 |
| 多行预警 | SQL 返回需要预警的数据行，有数据即触发 |

**API 数据源 - 判断层级**

```
请求层 → 仅判断请求成功/失败、状态码
    ↓
响应文本层 → 响应体字符串匹配（包含/不包含/等于/不等于）
    ↓
JSON解析层 → 解析JSON，按路径提取数据后判断
```

### 3.4 统计配置

#### 3.4.1 通用字段

| 字段 | 说明 |
|------|------|
| 统计名称 | 显示名称 |
| 系统分类 | 枚举选择 |
| 数据源类型 | SQL / API |
| 图表类型 | 表格 / 折线图 |
| 刷新间隔 | 秒 |
| 排序 | 显示排序 |
| 启用状态 | 是否启用 |

#### 3.4.2 SQL 数据源配置

| 字段 | 说明 |
|------|------|
| 数据库连接 | 下拉选择 |
| SQL 语句 | 查询语句 |

#### 3.4.3 API 数据源配置

直接在统计配置中填写 API 信息（同预警规则的 API 配置）：

| 字段 | 说明 |
|------|------|
| 请求地址 | API URL |
| 请求方式 | GET / POST |
| 请求头 | JSON 格式（可选） |
| 请求体 | 请求内容（可选） |
| 超时时间 | 秒 |
| 数据路径 | JSON 数据提取路径 |

#### 3.4.4 图表配置

**表格**
| 配置项 | 说明 |
|--------|------|
| 显示列 | 选择要显示的列 |
| 列标题 | 自定义列名 |
| 最大行数 | 默认20 |

**折线图**
| 配置项 | 说明 |
|--------|------|
| X轴字段 | 时间/分类字段 |
| Y轴字段 | 数值字段（支持多个） |
| 数据点数 | 最大显示点数（默认30） |

---

## 4. 客户端界面

### 4.1 主窗体

主窗体作为配置管理中心，采用左侧导航 + 右侧内容区布局。

**导航菜单**：
- **数据库连接**：管理数据库连接配置
- **预警规则**：配置预警规则（按系统分类分组显示）
- **统计配置**：配置统计规则
- **当前预警**：查看和处理当前预警
- **已忽略预警**：管理已忽略的预警
- **设置**：应用设置

**窗口行为**：
- 点击关闭按钮 → 最小化到托盘
- 启动时自动开始任务调度
- 支持开机自启动

### 4.2 托盘图标

| 状态 | 显示 |
|------|------|
| 正常 | 应用图标 |
| 有预警 | 图标 + 红点角标 |

**右键菜单**：
| 菜单项 | 功能 |
|--------|------|
| 打开主窗口 | 显示主窗体 |
| 显示悬浮窗 | 显示/隐藏悬浮窗 |
| 暂停任务 | 暂停/恢复定时任务 |
| 刷新数据 | 立即执行所有规则 |
| 退出 | 完全退出程序 |

### 4.3 桌面悬浮窗

#### 4.3.1 窗口特性
- 固定在桌面最上层
- 可拖拽位置
- 可调整大小
- 半透明背景
- 记忆位置和大小

#### 4.3.2 显示模式

**概览模式（默认）**
```
┌──────────────────────────────┐
│  项目监控                    │
├──────────────────────────────┤
│  ● 2   ● 5   ○ 3            │
│  严重   警告   信息          │
└──────────────────────────────┘
```

**列表模式**（点击展开）
```
┌────────────────────────────────────────────┐
│  项目监控                          [收起]  │
├────────────────────────────────────────────┤
│  ● 严重 (2)                                │
│    ├ 官网健康检查 - 站点无法访问           │
│    │   首次: 09:30  最后: 10:45  累计 15次 │
│    └ 支付接口 - 状态码: 502                │
│  ● 警告 (1)                                │
│    └ 订单积压预警 - 积压 1523 单           │
└────────────────────────────────────────────┘
```

#### 4.3.3 交互操作

| 操作 | 功能 |
|------|------|
| 点击概览区 | 展开列表模式 |
| 点击收起按钮 | 切换回概览模式 |
| 双击标题栏 | 打开主窗体 |
| 右键空白区域 | 刷新 / 暂停 / 设置 |
| 右键预警项 | 标记为：处理中 / 已忽略 / 已恢复 |

### 4.4 统计展示窗口

独立窗口展示统计数据，支持多个统计同时显示。

```
┌──────────────────────────────────────┐
│  今日订单统计            刷新: 60s   │
├──────────┬──────────┬────────────────┤
│  状态    │   数量   │    金额        │
├──────────┼──────────┼────────────────┤
│  待支付  │   156    │   ¥45,320     │
│  已支付  │   892    │   ¥234,560    │
└──────────┴──────────┴────────────────┘
```

---

## 5. 预警机制

### 5.1 预警级别

| 级别 | 颜色 | 说明 |
|------|------|------|
| 信息 | 蓝色 | 提示性信息 |
| 警告 | 橙色 | 需要关注 |
| 严重 | 红色 | 需要立即处理 |

### 5.2 预警聚合

同一规则持续异常时，采用聚合方式处理：

| 字段 | 说明 |
|------|------|
| 首次触发时间 | 第一次触发的时间 |
| 最后异常时间 | 最近一次异常的时间 |
| 累计异常次数 | 连续异常的总次数 |

**聚合规则**：
- 单值预警：按 `规则ID` 聚合
- 多行预警：按 `规则ID + 唯一标识字段值` 聚合

### 5.3 预警状态

| 状态 | 说明 | 计入总数 |
|------|------|---------|
| 未处理 | 默认状态 | 是 |
| 处理中 | 已开始处理 | 是 |
| 已忽略 | 不再显示 | 否 |
| 已恢复 | 自动恢复正常 | 否 |

---

## 6. 消息模板

### 6.1 变量语法

使用 `{$变量名}` 格式引用变量。

### 6.2 系统变量

| 变量 | 说明 |
|------|------|
| `{$name}` | 规则名称 |
| `{$category}` | 系统分类名称 |
| `{$level}` | 预警级别 |
| `{$threshold}` | 配置的阈值 |
| `{$rowCount}` | 结果行数 |

### 6.3 数据变量

**SQL 数据源**：
| 变量 | 说明 |
|------|------|
| `{$table.列名}` | 当前行指定列的值 |

**API 数据源**：
| 变量 | 说明 |
|------|------|
| `{$api.statusCode}` | HTTP 状态码 |
| `{$api.value}` | 简单值 |
| `{$api.属性名}` | 对象/数组元素的属性 |

### 6.4 示例

```
{$name} - 积压 {$table.cnt} 单
{$table.customer_name} {$table.error_msg}，金额: {$table.amount}元
{$name} - 站点无法访问（状态码: {$api.statusCode}）
```

---

## 7. 数据存储

### 7.1 本地 SQLite 数据库

配置数据存储在本地 SQLite 数据库中。

**数据表**：

```sql
-- 数据库连接配置
CREATE TABLE db_connections (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    db_type TEXT NOT NULL,  -- SqlServer / MySql
    connection_string TEXT NOT NULL,
    enabled INTEGER DEFAULT 1,
    created_at TEXT,
    updated_at TEXT
);

-- 预警规则
CREATE TABLE alert_rules (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    category INTEGER DEFAULT 0,  -- SystemCategory 枚举值
    source_type TEXT NOT NULL,   -- Sql / Api

    -- SQL 配置
    db_connection_id INTEGER,
    sql_query TEXT,

    -- API 配置（内联）
    api_url TEXT,
    api_method TEXT,
    api_headers TEXT,
    api_body TEXT,
    api_timeout INTEGER DEFAULT 30,

    -- 判断配置
    judge_level TEXT,      -- 请求层/响应文本层/JSON解析层
    data_path TEXT,
    judge_type TEXT,       -- 单值/多行
    judge_field TEXT,
    judge_operator TEXT,
    judge_value TEXT,
    key_field TEXT,

    -- 预警配置
    alert_level INTEGER DEFAULT 1,
    message_template TEXT,
    cron_expression TEXT NOT NULL,
    fail_threshold INTEGER DEFAULT 1,

    -- 状态
    enabled INTEGER DEFAULT 1,
    current_fail_count INTEGER DEFAULT 0,
    last_run_time TEXT,
    last_run_success INTEGER,
    last_run_result TEXT,

    created_at TEXT,
    updated_at TEXT
);

-- 统计配置
CREATE TABLE stat_configs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    category INTEGER DEFAULT 0,
    source_type TEXT NOT NULL,

    -- SQL 配置
    db_connection_id INTEGER,
    sql_query TEXT,

    -- API 配置（内联）
    api_url TEXT,
    api_method TEXT,
    api_headers TEXT,
    api_body TEXT,
    api_timeout INTEGER DEFAULT 30,
    data_path TEXT,

    -- 图表配置
    chart_type TEXT NOT NULL,  -- Table / LineChart
    chart_config TEXT,         -- JSON 格式的图表配置
    refresh_interval INTEGER DEFAULT 60,
    sort_order INTEGER DEFAULT 0,

    enabled INTEGER DEFAULT 1,
    created_at TEXT,
    updated_at TEXT
);

-- 当前预警
CREATE TABLE current_alerts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    rule_id INTEGER NOT NULL,
    alert_key TEXT,
    message TEXT NOT NULL,
    alert_level INTEGER NOT NULL,
    status INTEGER DEFAULT 0,  -- 0:未处理 1:处理中 2:已忽略 3:已恢复
    first_time TEXT NOT NULL,
    last_time TEXT NOT NULL,
    occur_count INTEGER DEFAULT 1,
    created_at TEXT,
    updated_at TEXT
);

-- 已忽略预警
CREATE TABLE ignored_alerts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    rule_id INTEGER NOT NULL,
    alert_key TEXT,
    ignored_at TEXT NOT NULL
);

-- 应用设置
CREATE TABLE app_settings (
    key TEXT PRIMARY KEY,
    value TEXT
);
```

---

## 8. 应用设置

| 设置项 | 说明 | 默认值 |
|--------|------|--------|
| 开机自启动 | 系统启动时自动运行 | 否 |
| 启动时显示悬浮窗 | 启动后自动显示悬浮窗 | 是 |
| 悬浮窗透明度 | 0.3 - 1.0 | 0.9 |
| 悬浮窗位置 | X, Y 坐标 | 右下角 |
| 悬浮窗大小 | 宽, 高 | 300x200 |
| 自动恢复延迟 | 预警恢复后延迟消失时间（秒） | 0（立即消失） |

---

## 9. 开发计划

### 阶段一：基础框架
- [ ] 项目结构重构（移除 Api 项目，合并到 WPF）
- [ ] SQLite 本地存储实现
- [ ] 枚举系统分类
- [ ] 数据库连接管理界面

### 阶段二：预警功能
- [ ] 预警规则配置界面（SQL + API 内联配置）
- [ ] Quartz 任务调度（内嵌）
- [ ] SQL 预警执行器
- [ ] API 预警执行器
- [ ] 悬浮窗显示

### 阶段三：统计功能
- [ ] 统计配置界面
- [ ] 表格展示
- [ ] 折线图展示

### 阶段四：完善优化
- [ ] 托盘图标和菜单
- [ ] 开机自启动
- [ ] 界面美化
- [ ] 性能优化

---

## 10. V1 到 V2 变更对照

| 项目 | V1 | V2 |
|------|----|----|
| 管理端 | Web 端独立部署 | **移除**，配置集成到客户端 |
| 后端服务 | 独立 API 服务 | **移除**，任务调度内嵌客户端 |
| 系统管理 | 动态增删改查 | **枚举**，代码定义 |
| 数据源-数据库 | 独立管理 | **保留**，集中配置 |
| 数据源-API | 独立管理 | **移除**，内联到规则配置 |
| 配置存储 | MySQL | **SQLite**（本地） |
| 部署方式 | Web + API + WPF | **仅 WPF 客户端** |

---

## 11. 典型使用流程

### 11.1 配置数据库预警

1. 打开主窗体 → 数据库连接 → 新增连接
2. 填写连接名称、选择类型、输入连接串 → 测试连接 → 保存
3. 预警规则 → 新增规则
4. 填写规则名称、选择系统分类
5. 数据源类型选择"SQL"
6. 选择数据库连接、输入 SQL 语句
7. 配置判断方式、阈值
8. 设置 Cron 表达式、消息模板
9. 保存并启用

### 11.2 配置 API 预警

1. 预警规则 → 新增规则
2. 数据源类型选择"API"
3. 填写 API 地址、请求方式、请求头/体
4. 选择判断层级、配置判断条件
5. 设置 Cron 表达式、消息模板
6. 保存并启用

### 11.3 处理预警

1. 悬浮窗显示预警数量
2. 点击展开查看详情
3. 右键预警项 → 标记为"处理中"
4. 问题解决后，系统自动检测恢复或手动标记"已恢复"
