# 项目监控 - 产品需求文档

## 1. 项目概述

一个监控系统，支持两大核心功能：
1. **预警监控**：定时执行 SQL 查询或 API 调用，当结果不符合预期时触发预警，通过桌面悬浮窗等方式展示预警信息
2. **数据统计**：配置统计规则，定时查询数据并以表格或图表形式展示

**目标用户**：开发/运维人员、项目管理者

**使用场景**：
- 监控业务数据异常（订单积压、库存预警等）
- 监控系统指标（API响应时间、错误率等）
- 定时检查数据一致性
- **站点健康检查**（定时访问API，检测是否可用）
- **数据统计展示**（实时查看业务数据指标、趋势图等）

---

## 2. 系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        系统架构                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌───────────────┐         ┌───────────────┐              │
│   │   管理端       │         │   展示端       │              │
│   │   (Web)       │         │   (桌面端)     │              │
│   │               │         │               │              │
│   │ • 系统管理    │         │ • 悬浮窗显示   │              │
│   │ • 数据源管理   │         │ • 预警列表    │              │
│   │ • 预警规则    │         │ • 统计展示    │              │
│   │ • 统计配置    │         │ • 状态处理    │              │
│   │ • 忽略管理    │         │               │              │
│   └───────┬───────┘         └───────┬───────┘              │
│           │                         │                       │
│           ▼                         ▼                       │
│   ┌─────────────────────────────────────────┐              │
│   │              后端 API 服务               │              │
│   │                                         │              │
│   │  • 配置管理接口                          │              │
│   │  • 预警查询接口                          │              │
│   │  • 统计数据接口                          │              │
│   │  • 状态更新接口                          │              │
│   │  • 定时任务调度                          │              │
│   └─────────────────┬───────────────────────┘              │
│                     │                                       │
│                     ▼                                       │
│   ┌─────────────────────────────────────────┐              │
│   │                数据库                    │              │
│   │                                         │              │
│   │  • 配置存储（数据源、规则、统计）            │              │
│   │  • 运行时状态（当前预警、统计结果）         │              │
│   └─────────────────────────────────────────┘              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 系统组成

| 组件 | 职责 |
|------|------|
| **管理端** | Web 端配置管理（系统、数据源、预警规则、统计配置），无需登录 |
| **展示端** | 桌面悬浮窗显示预警和统计数据，处理预警状态 |
| **后端服务** | 提供 API 接口，执行定时任务 |
| **数据库** | 存储配置和运行时数据 |
| **移动端** | （暂不实现）后期扩展 |

### 2.3 功能划分

#### 管理端（Web）
- 系统管理：管理业务系统（名称、启用状态、排序），用于对预警规则和统计配置进行分类
- 数据源管理：增删改查数据库连接、API配置
- 预警规则配置：按系统分类管理
- **统计配置**：配置统计规则（数据源、图表类型、刷新时间）
- 预警结果：查看和管理当前预警
- 已忽略预警管理（查看、取消忽略）
- 系统设置

#### 展示端（WPF）
- **主窗体**：管理桌面工具的启动/停止
- **任务栏托盘图标**：最小化后驻留托盘，右键菜单操作
- 桌面悬浮窗（概览模式 / 列表模式）
- 查看当前预警
- **统计数据展示**（表格、折线图等）
- 右键处理预警状态（处理中、已忽略、已恢复）
- 开机自启动
- 定时刷新预警和统计数据

#### 后端服务
- RESTful API 接口
- 定时任务调度（执行预警检测和统计查询）
- 预警判断逻辑
- 统计数据查询
- 数据库访问

---

## 3. 功能需求

### 3.1 系统管理

管理业务系统，用于对预警规则和统计配置进行分类。

| 字段 | 说明 |
|------|------|
| 系统名称 | 业务系统的名称（如：订单中心、支付中心） |
| 排序 | 显示排序 |
| 启用状态 | 是否启用 |

### 3.2 数据源管理

#### 3.2.1 数据库连接
| 项目 | 说明 |
|------|------|
| 支持类型 | SQL Server、MySQL |
| 配置项 | 服务器地址、端口、数据库名、用户名、密码 |
| 功能 | 连接测试、多数据源管理 |

#### 3.2.2 API 接口
| 项目 | 说明 |
|------|------|
| 请求方式 | GET、POST |
| 认证方式 | 无认证 / API Key（Header） |
| 配置项 | URL、请求头、请求体、超时时间 |

**API 返回格式约定**

API 统一返回以下格式：
```json
{
    "Data": ...,        // 实际数据（可能是值、对象、数组）
    "Count": 0,         // 数据条数
    "ErrorCode": 0,     // 错误码，0=成功
    "IsSuccess": true,  // 是否成功
    "Msg": "操作成功"
}
```

**Data 字段的三种形态**：

| 形态 | 示例 | 应用场景 |
|------|------|---------|
| 简单值 | `"Data": "healthy"` 或 `"Data": 156` | 健康检查、单一统计值 |
| 对象 | `"Data": { "errorCount": 23, "pending": 10 }` | 多维度统计 |
| 数组 | `"Data": [{ "id": 1, "name": "..." }, ...]` | 异常数据列表、多行预警 |

### 3.3 预警规则

#### 3.3.1 规则属性

**通用字段**：
| 字段 | 说明 |
|------|------|
| 规则名称 | 规则的显示名称 |
| 所属系统 | 关联的业务系统（可选） |
| 数据源 | 选择数据库连接或API接口（选择后显示对应的配置项） |
| 预警级别 | 信息 / 警告 / 严重 |
| 连续失败次数 | 连续失败N次才预警，避免误报（默认1） |
| 定时规则 | Cron 表达式 |
| 消息模板 | 预警消息模板，支持变量（见第8节） |
| 启用状态 | 是否启用 |

**SQL 数据源专用字段**：
| 字段 | 说明 |
|------|------|
| SQL语句 | 要执行的查询语句 |
| 判断方式 | 单值预警 / 多行预警 |
| 判断字段 | （单值预警）用于判断的列名 |
| 运算符 | （单值预警）比较运算符 |
| 阈值 | （单值预警）比较阈值 |
| 唯一标识字段 | （多行预警）用于区分不同预警的列名 |

**API 数据源专用字段**：
| 字段 | 说明 |
|------|------|
| 判断层级 | 请求层 / 响应文本层 / JSON解析层 |
| 数据路径 | （JSON解析层）从返回JSON中提取数据的路径 |
| 判断方式 | 单值预警 / 多行预警（JSON解析层），或请求层/响应文本层的特定判断 |
| 判断字段 | （单值预警 + 对象类型）用于判断的属性名 |
| 运算符 | （单值预警）比较运算符 |
| 阈值/比较值 | （单值预警）比较阈值或文本 |
| 唯一标识字段 | （多行预警）用于区分不同预警的属性名 |

#### 3.3.2 判断方式

**【SQL 数据源】**

SQL 查询结果始终为表格（Table），根据判断方式不同：

**单值预警**
- 约定 SQL 返回**单行单列**（或取第一行指定列）
- 取指定列的值与阈值进行比较
- 运算符：`>`, `>=`, `<`, `<=`, `=`, `!=`
- 满足条件时生成**单条预警**
- 示例：`SELECT COUNT(*) as cnt FROM ...`，当 `cnt > 100` 时预警

**多行预警**
- 约定 SQL 只返回**需要预警的数据**
- **有数据返回即触发预警**，无需配置运算符和阈值
- 每行数据生成一条独立预警
- 必须配置**唯一标识字段**用于区分不同预警
- 示例：`SELECT error_id, customer_name, error_msg FROM error_logs WHERE status='unresolved'`

---

**【API 数据源】**

API 判断分为三个层级，按需选择：

```
┌─────────────────────────────────────────────────────────────┐
│  判断层级选择                                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─ 请求层 ────────────────────────────────────────────┐   │
│  │  仅判断请求是否成功                                  │   │
│  │  • 请求失败（超时/无法连接/DNS解析失败）             │   │
│  │  • 状态码判断（= / != / >= / < 某个值）             │   │
│  │  适用：简单的站点可用性检查                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                          ↓                                  │
│  ┌─ 响应文本层 ────────────────────────────────────────┐   │
│  │  把响应体当作字符串进行匹配                          │   │
│  │  • 等于 / 不等于 / 包含 / 不包含                    │   │
│  │  适用：响应格式简单或不固定的场景                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                          ↓                                  │
│  ┌─ JSON解析层 ────────────────────────────────────────┐   │
│  │  解析JSON后按数据路径提取，根据提取结果类型判断       │   │
│  │  • 简单值 → 数值比较 / 文本判断（单条预警）          │   │
│  │  • 对象   → 指定字段的数值/文本判断（单条预警）      │   │
│  │  • 数组   → 行数判断（可多行预警）                   │   │
│  │  适用：需要精确解析JSON结构的场景                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**请求层判断**：
| 判断类型 | 说明 |
|----------|------|
| 请求失败 | 超时、无法连接、DNS解析失败等 |
| 状态码判断 | HTTP状态码的数值比较，如 `!= 200` |

**响应文本层判断**：
| 判断类型 | 说明 |
|----------|------|
| 等于 | 响应体完全等于指定文本 |
| 不等于 | 响应体不等于指定文本 |
| 包含 | 响应体包含指定文本 |
| 不包含 | 响应体不包含指定文本 |

**JSON解析层判断**：

首先配置**数据路径**提取目标数据：
| 路径示例 | 说明 |
|---------|------|
| `data` | 取data字段 |
| `data.errorCount` | 取data对象的errorCount属性 |
| `data.items` | 取data对象的items数组 |
| `result.list[0].name` | 支持数组索引访问 |

然后根据**提取结果的类型**选择判断方式：

| 提取结果类型 | 可选判断方式 | 预警方式 |
|-------------|-------------|---------|
| 简单值（字符串/数字） | 单值预警（数值比较 / 文本判断） | 单条预警 |
| 对象 | 单值预警（指定字段的数值/文本判断） | 单条预警 |
| 数组 | 多行预警（有数据即预警） | 每个元素一条预警 |

---

**【通用配置】**

**连续失败次数**
- 可配置"连续失败 N 次才触发预警"
- 避免网络抖动导致的误报
- 默认值：1（单次失败即预警）
- 建议值：2-3 次

---

#### 3.3.3 典型场景示例

**场景1：SQL 单值预警**

| 配置项 | 值 |
|--------|-----|
| 规则名称 | 订单积压预警 |
| 数据源 | MySQL: 业务库 |
| SQL语句 | `SELECT COUNT(*) as cnt FROM orders WHERE status='pending' AND created_at < NOW() - INTERVAL 30 MINUTE` |
| 判断方式 | 单值预警 |
| 判断字段 | cnt |
| 运算符 | > |
| 阈值 | 100 |
| 预警级别 | 警告 |
| 消息模板 | `{$name} - 积压 {$table.cnt} 单` |

**显示效果**：
```
订单积压预警 - 积压 1523 单
首次: 09:30  最后: 11:00  累计 4次
```

**场景2：SQL 多行预警（错误日志监控）**

SQL 只返回需要预警的数据，有数据返回即触发预警。

| 配置项 | 值 |
|--------|-----|
| 规则名称 | 客户操作异常 |
| 数据源 | MySQL: 业务库 |
| SQL语句 | `SELECT error_id, customer_name, error_msg, amount FROM error_logs WHERE created_at > DATE_SUB(NOW(), INTERVAL 1 HOUR) AND status = 'unresolved'` |
| 判断方式 | 多行预警 |
| **唯一标识字段** | error_id |
| 预警级别 | 警告 |
| 消息模板 | `{$table.customer_name} {$table.error_msg}，金额: {$table.amount}元` |

**显示效果**：
```
┌────────────────────────────────────────────────┐
│  ● 警告 (3)                                    │
│    ├ 张三 支付超时，金额: 500元                │
│    │   首次: 09:30  最后: 10:45  累计 5次      │
│    ├ 李四 余额不足，金额: 200元                │
│    │   首次: 10:00  最后: 10:30  累计 2次      │
│    └ 王五 网络异常，金额: 800元                │
│        首次: 10:20  最后: 10:20  累计 1次      │
└────────────────────────────────────────────────┘
```

**聚合规则**：
- 按 `规则ID + 唯一标识字段值` 组合进行聚合
- 同一 key 的错误再次出现 → 更新现有预警（累计次数+1）
- 新的 key 出现 → 新增一条预警
- 某个 key 不再出现（错误已解决）→ 该预警自动消失

**场景3：API 请求层判断（健康检查）**

最简单的健康检查，只要能访问就行。

| 配置项 | 值 |
|--------|-----|
| 规则名称 | 官网健康检查 |
| 数据源 | API: https://www.example.com/api/health |
| 判断层级 | 请求层 |
| 判断方式 | 请求失败 或 状态码 != 200 |
| 预警级别 | 严重 |
| 连续失败 | 2次 |
| 消息模板 | `{$name} - 站点无法访问（状态码: {$api.statusCode}）` |

**场景4：API 响应文本层判断**

响应格式不固定，直接匹配文本。

| 配置项 | 值 |
|--------|-----|
| 规则名称 | 服务状态检查 |
| 数据源 | API: https://api.example.com/status |
| 判断层级 | 响应文本层 |
| 判断方式 | 不包含 |
| 判断值 | "healthy" |
| 预警级别 | 警告 |
| 消息模板 | `{$name} - 服务状态异常` |

**场景5：API JSON解析 - 简单值**

API返回：`{ "data": "healthy", "code": 0 }`

| 配置项 | 值 |
|--------|-----|
| 规则名称 | 系统健康检查 |
| 数据源 | API: https://api.example.com/health |
| 判断层级 | JSON解析层 |
| 数据路径 | data |
| 判断方式 | 文本不等于 |
| 判断值 | healthy |
| 预警级别 | 严重 |
| 消息模板 | `{$name} - 状态异常: {$api.value}` |

**场景6：API JSON解析 - 对象**

API返回：`{ "data": { "errorCount": 23, "pendingCount": 156 }, "code": 0 }`

| 配置项 | 值 |
|--------|-----|
| 规则名称 | 异常订单监控 |
| 数据源 | API: https://api.example.com/stats |
| 判断层级 | JSON解析层 |
| 数据路径 | data |
| 判断方式 | 数值比较 |
| 判断字段 | errorCount |
| 判断条件 | > 0 |
| 预警级别 | 警告 |
| 消息模板 | `{$name} - 错误 {$api.errorCount} 条，待处理 {$api.pendingCount} 条` |

**场景7：API JSON解析 - 数组（多行预警）**

API 只返回需要预警的数据，有数据返回即触发预警。

API返回：
```json
{
  "data": {
    "errors": [
      { "id": "001", "customer": "张三", "msg": "支付超时" },
      { "id": "002", "customer": "李四", "msg": "余额不足" }
    ]
  },
  "code": 0
}
```

| 配置项 | 值 |
|--------|-----|
| 规则名称 | 客户异常监控 |
| 数据源 | API: https://api.example.com/errors |
| 判断层级 | JSON解析层 |
| 数据路径 | data.errors |
| 判断方式 | 多行预警 |
| **唯一标识字段** | id |
| 预警级别 | 警告 |
| 消息模板 | `客户[{$api.customer}] {$api.msg}` |

**显示效果**：与 SQL 多行预警相同，每个数组元素作为独立预警。

#### 3.3.4 预警级别
| 级别 | 颜色 | 说明 |
|------|------|------|
| 信息 (Info) | 蓝色 | 提示性信息 |
| 警告 (Warning) | 橙色 | 需要关注 |
| 严重 (Critical) | 红色 | 需要立即处理 |

#### 3.3.5 预警聚合机制

当同一规则**持续异常**时，采用聚合方式处理，避免重复刷屏：

**聚合规则**：
- 同一规则的预警只计为 **1 条**，不重复累加预警总数
- 不新增明细记录，而是**更新现有预警**的状态

**预警状态字段**：
| 字段 | 说明 |
|------|------|
| 首次触发时间 | 该预警第一次触发的时间 |
| 最后异常时间 | 最近一次检测异常的时间 |
| 累计异常次数 | 该规则连续异常的总次数 |

**显示效果**：
```
某某站点访问异常
首次触发: 2024-01-15 09:30
最后异常: 2024-01-15 10:45
累计 15 次
```

**预警恢复**：
- 当规则检测结果恢复正常时，该预警**自动消失**
- 下次再触发时，重新作为新预警计数

#### 3.3.6 预警状态管理

每条预警可标记处理状态，便于跟踪问题处理进度。

**状态定义**：
| 状态 | 说明 | 计入预警总数 |
|------|------|-------------|
| 未处理 | 默认状态，新预警 | 是 |
| 处理中 | 已开始处理，尚未解决 | 是 |
| 已忽略 | 忽略该预警，不再显示 | 否 |
| 已恢复 | 问题已解决 | 否 |

**状态流转**：
```
┌─────────┐
│  未处理  │ ← 新预警触发
└────┬────┘
     │ 用户操作
     ▼
┌─────────┐     ┌─────────┐
│  处理中  │ ──→ │  已恢复  │ ← 系统自动检测正常 或 用户手动标记
└─────────┘     └─────────┘
     │
     ▼
┌─────────┐
│  已忽略  │ → 该key的预警不再显示，直到用户取消忽略
└─────────┘
```

**忽略规则**：
- 标记为"已忽略"后，该 `规则ID + alert_key` 的预警不再显示
- 即使后续检测仍异常，也不会出现在预警列表中
- 用户可在配置界面查看和取消忽略

**自动恢复**：
- 系统检测到规则结果恢复正常时，自动标记为"已恢复"
- 已恢复的预警短暂显示后自动消失（或立即消失，可配置）

**界面操作**：
- 右键预警项 → 标记为：处理中 / 已忽略 / 已恢复
- 悬浮窗只显示"未处理"和"处理中"的预警

### 3.4 统计配置

统计功能用于定时查询数据并以可视化方式展示，便于实时了解业务指标。

#### 3.4.1 统计规则属性

| 字段 | 说明 |
|------|------|
| 统计名称 | 统计规则的显示名称 |
| 所属系统 | 关联的业务系统（可选） |
| 数据源 | 选择数据库连接或API接口 |
| 查询内容 | SQL语句或API配置 |
| 图表类型 | 表格（Table） / 折线图（Line Chart） |
| 刷新时间 | 数据刷新间隔（秒） |
| 排序 | 显示排序 |
| 启用状态 | 是否启用 |

#### 3.4.2 图表类型

**表格（Table）**

直接展示查询结果的表格数据。

| 配置项 | 说明 |
|--------|------|
| 显示列 | 选择要显示的列（默认全部） |
| 列标题 | 自定义列的显示标题 |
| 最大行数 | 限制显示的最大行数（默认20） |

适用场景：
- 实时数据明细展示
- 多列数据对比
- 快速查看原始数据

**折线图（Line Chart）**

将时序数据以折线图形式展示。

| 配置项 | 说明 |
|--------|------|
| X轴字段 | 时间/分类字段（如：date, hour） |
| Y轴字段 | 数值字段，支持多个（如：count, amount） |
| 图例名称 | 自定义Y轴各字段的显示名称 |
| 数据点数 | 最大显示的数据点数（默认30） |

适用场景：
- 趋势分析（订单量、访问量等）
- 时间序列对比
- 指标监控

#### 3.4.3 典型场景示例

**场景1：订单统计表格**

| 配置项 | 值 |
|--------|-----|
| 统计名称 | 今日订单统计 |
| 数据源 | MySQL: 业务库 |
| SQL语句 | `SELECT status, COUNT(*) as count, SUM(amount) as total FROM orders WHERE DATE(created_at) = CURDATE() GROUP BY status` |
| 图表类型 | 表格 |
| 刷新时间 | 60秒 |

**显示效果**：
```
┌──────────────────────────────────────┐
│  今日订单统计            刷新: 60s   │
├──────────┬──────────┬────────────────┤
│  状态    │   数量   │    金额        │
├──────────┼──────────┼────────────────┤
│  待支付  │   156    │   ¥45,320     │
│  已支付  │   892    │   ¥234,560    │
│  已完成  │   1,245  │   ¥456,780    │
└──────────┴──────────┴────────────────┘
```

**场景2：订单趋势折线图**

| 配置项 | 值 |
|--------|-----|
| 统计名称 | 近7日订单趋势 |
| 数据源 | MySQL: 业务库 |
| SQL语句 | `SELECT DATE(created_at) as date, COUNT(*) as order_count, SUM(amount) as total_amount FROM orders WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY) GROUP BY DATE(created_at) ORDER BY date` |
| 图表类型 | 折线图 |
| X轴字段 | date |
| Y轴字段 | order_count, total_amount |
| 刷新时间 | 300秒 |

**显示效果**：
```
┌──────────────────────────────────────────────┐
│  近7日订单趋势                    刷新: 5min │
├──────────────────────────────────────────────┤
│                                              │
│  1500 ┤                        ╭─╮          │
│  1200 ┤              ╭─╮   ╭──╯  ╰─╮        │
│   900 ┤         ╭───╯  ╰──╯        ╰──╮     │
│   600 ┤    ╭───╯                       ╰─   │
│   300 ┤───╯                                 │
│       └──────────────────────────────────   │
│         12/18  19   20   21   22   23   24  │
│                                              │
│  ── 订单数量   ── 订单金额                   │
└──────────────────────────────────────────────┘
```

**场景3：API数据统计**

| 配置项 | 值 |
|--------|-----|
| 统计名称 | 服务器资源监控 |
| 数据源 | API: https://api.example.com/server/stats |
| 数据路径 | data |
| 图表类型 | 表格 |
| 刷新时间 | 30秒 |

### 3.5 定时执行

预警规则和统计配置都支持定时执行。使用 Cron 表达式配置执行时间：
| 示例 | 说明 |
|------|------|
| `0 */5 * * * ?` | 每5分钟执行 |
| `0 0 * * * ?` | 每小时执行 |
| `0 0 9 * * ?` | 每天9点执行 |
| `0 0 9 * * MON-FRI` | 工作日9点执行 |

### 3.6 展示端 - 主窗体与托盘

#### 3.6.1 主窗体

主窗体是WPF展示端的管理中心，用于控制各个桌面工具的启动和停止。

**主窗体功能**：
| 功能 | 说明 |
|------|------|
| 工具列表 | 显示所有可用的桌面工具（预警监控、数据统计、完整面板） |
| 启动/停止 | 单独控制每个工具的运行状态 |
| 状态显示 | 显示每个工具的运行状态（运行中/已停止） |
| 快捷入口 | 打开管理端、设置等 |

**窗口行为**：
- 点击关闭按钮 → 最小化到任务栏托盘（不退出程序）
- 点击最小化按钮 → 最小化到任务栏托盘
- 双击托盘图标 → 还原主窗体

#### 3.6.2 任务栏托盘图标

程序最小化后驻留在任务栏托盘区，通过图标和右键菜单进行操作。

**托盘图标**：
| 状态 | 图标显示 |
|------|---------|
| 正常 | 应用图标 |
| 有预警 | 应用图标 + 红点角标 |

**右键菜单操作**：
| 菜单项 | 功能 |
|--------|------|
| 打开主窗口 | 还原并显示主窗体 |
| 打开管理端 | 在浏览器中打开Web管理端 |
| 启动所有工具 | 启动所有桌面悬浮窗工具 |
| 暂停所有任务 | 暂停所有定时任务（保持窗口显示） |
| 刷新数据 | 立即刷新预警和统计数据 |
| 设置 | 打开设置窗口 |
| 退出程序 | 完全退出应用程序 |

### 3.7 展示端 - 桌面悬浮窗

#### 3.7.1 窗口特性
- **固定在桌面**：始终显示，不被其他窗口遮挡
- **可拖拽**：用户可拖动到任意位置
- **可调整大小**：支持调整窗口尺寸
- **半透明**：不影响正常工作
- **记忆位置**：重启后恢复上次位置

#### 3.7.2 显示模式

**概览模式（默认）**
```
┌──────────────────────────────┐
│  项目监控                    │
├──────────────────────────────┤
│  ● 2   ● 5   ○ 3            │
│  严重   警告   信息           │
└──────────────────────────────┘
```
- 显示各级别预警数量
- 无预警时显示"一切正常"

**列表模式**
```
┌────────────────────────────────────────────┐
│  项目监控                          [收起]  │
├────────────────────────────────────────────┤
│  ● 严重 (2)                                │
│    ├ 官网健康检查 - 站点访问异常           │
│    │   首次: 09:30  最后: 10:45  累计 15次 │
│    └ 支付接口检测 - 状态码: 502            │
│        首次: 10:00  最后: 10:15  累计 3次  │
│  ● 警告 (1)                                │
│    └ 订单积压预警 - 积压 1523 单           │
│        首次: 08:00  最后: 10:40  累计 8次  │
└────────────────────────────────────────────┘
```
- 按级别分组显示预警项
- 每条预警显示：
  - 规则名称 + 预警消息
  - 首次触发时间、最后异常时间、累计次数

#### 3.7.3 交互操作
| 操作 | 功能 |
|------|------|
| 单击概览区 | 展开列表模式 |
| 单击收起按钮 | 切换回概览模式 |
| 双击标题栏 | 打开主配置窗口 |
| 右键空白区域 | 刷新 / 暂停监控 / 设置 / 退出 |
| 右键预警项 | 标记为：处理中 / 已忽略 / 已恢复 |
| 拖拽边缘 | 调整窗口大小 |

### 3.8 管理端 - 主配置界面

左侧导航 + 右侧内容区布局：
- **系统管理**：管理业务系统，用于分类预警规则和统计配置
- **数据源管理**：增删改查数据库连接和API配置
- **预警规则**：配置具体的预警规则，按系统分类
- **统计配置**：配置统计规则和图表展示
- **预警结果**：查看和管理当前预警
- **已忽略预警**：查看和取消忽略的预警
- **系统设置**：应用设置（数据库连接、悬浮窗样式等）

### 3.9 通知方式

#### 第一版（MVP）
- 桌面悬浮窗实时显示
- 无声音提示

#### 后续版本
- 邮件通知
- 企业微信机器人
- 钉钉机器人
- 声音提示（可选）

---

## 4. 非功能需求

### 4.1 性能
- 单次查询超时时间可配置（默认30秒）
- 支持并发执行多个规则
- 悬浮窗刷新不阻塞主线程

### 4.2 可靠性
- 查询失败时记录错误，不影响其他规则执行
- 数据库连接断开自动重连

### 4.3 易用性
- Cron 表达式提供常用模板
- SQL 编辑器支持语法高亮（可选）

---

## 5. 开发阶段

### 阶段一：MVP
- [ ] 项目结构搭建
- [ ] MySQL 配置存储连接
- [ ] 数据源管理（SQL Server / MySQL）
- [ ] 预警规则基础配置
- [ ] Cron 定时执行引擎
- [ ] 桌面悬浮窗（概览+列表）

### 阶段二：功能完善
- [ ] API 数据源支持
- [ ] 自定义表达式判断
- [ ] 系统管理
- [ ] 悬浮窗样式美化

### 阶段三：通知扩展
- [ ] 邮件通知
- [ ] 企业微信/钉钉通知
- [ ] 声音提示

### 阶段四：高级功能
- [ ] 悬浮窗统计组件
- [ ] 预警历史记录（可选）
- [ ] 移动端 APP

---

## 6. 需求确认记录

| 问题 | 结论 |
|------|------|
| 敏感信息加密 | 不需要，依赖数据库本身安全性 |
| 开机自启动 | 需要，支持开机自动启动悬浮窗 |
| 规则导入导出 | 不需要，配置已在MySQL，直接连库即可 |
| 预警消息模板 | 需要，支持自定义模板如 `{name} - 当前值:{value}` |

---

## 7. 预警消息模板

支持在规则中配置消息模板，通过变量占位符在运行时动态替换为实际值。

### 7.1 变量语法

所有变量使用 `{$变量名}` 格式，`$` 前缀用于区分系统变量和数据字段。

### 7.2 通用系统变量

| 变量 | 说明 |
|------|------|
| `{$name}` | 规则名称 |
| `{$system}` | 所属系统名 |
| `{$level}` | 预警级别（info/warning/critical） |
| `{$threshold}` | 配置的判断阈值 |
| `{$rowCount}` | 结果行数（SQL）或数组长度（API） |

> 注：`首次触发时间`、`最后异常时间`、`累计次数` 会自动显示在预警明细的副标题中，消息模板中无需包含。

### 7.3 SQL 数据源变量

SQL 查询结果始终为表格（Table），使用 `{$table.列名}` 语法访问字段值。

| 变量 | 说明 |
|------|------|
| `{$table.列名}` | 当前行指定列的值 |

**单行预警**：取第一行数据渲染模板
```
SQL: SELECT COUNT(*) as cnt FROM orders WHERE status='pending'
模板: {$name} - 积压 {$table.cnt} 单
结果: 订单积压预警 - 积压 1523 单
```

**多行预警**：每行数据渲染一次模板，生成多条预警
```
SQL: SELECT error_id, customer_name, error_msg, amount FROM error_logs
模板: {$table.customer_name} {$table.error_msg}，金额: {$table.amount}元
结果:
  - 张三 支付超时，金额: 500元
  - 李四 余额不足，金额: 200元
```

### 7.4 API 数据源变量

API 使用 `{$api.xxx}` 语法访问数据，根据判断层级不同，可用变量有所区别。

**请求层变量**：
| 变量 | 说明 |
|------|------|
| `{$api.statusCode}` | HTTP状态码 |
| `{$api.url}` | 请求URL |

**响应文本层变量**：
| 变量 | 说明 |
|------|------|
| `{$api.body}` | 响应体原文 |
| `{$api.statusCode}` | HTTP状态码 |

**JSON解析层变量**：

根据数据路径提取结果的类型，变量访问方式不同：

| 提取结果类型 | 变量访问 | 示例 |
|-------------|---------|------|
| 简单值（字符串/数字） | `{$api.value}` | 提取 `data` 得到 `"healthy"` → `{$api.value}` = `healthy` |
| 对象 | `{$api.属性名}` | 提取 `data` 得到 `{errorCount: 23}` → `{$api.errorCount}` = `23` |
| 数组（多行预警） | `{$api.属性名}` | 遍历数组，每个元素用 `{$api.xxx}` 访问其属性 |

### 7.5 示例模板

**SQL 数据源**：
```
{$name} - 积压 {$table.cnt} 单（阈值 {$threshold}）
{$table.customer_name} {$table.error_msg}，金额: {$table.amount}元
[{$system}] {$name} 触发预警，共 {$rowCount} 条数据
```

**API 数据源**：
```
{$name} - 站点无法访问（状态码: {$api.statusCode}）
{$name} - 状态异常: {$api.value}
{$name} - 错误 {$api.errorCount} 条，待处理 {$api.pendingCount} 条
客户[{$api.customer}] {$api.msg}
```

### 7.6 变量解析优先级

```
┌─────────────────────────────────────────────────────────────┐
│  1. 系统变量                                                 │
│     {$name}, {$system}, {$level}, {$threshold}, {$rowCount} │
│     → 从规则配置和执行上下文获取                              │
├─────────────────────────────────────────────────────────────┤
│  2. 数据变量                                                 │
│     SQL: {$table.列名} → 从当前行数据获取                    │
│     API: {$api.属性名} → 从提取结果获取                      │
└─────────────────────────────────────────────────────────────┘
```
